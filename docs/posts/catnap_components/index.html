<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Break it up! Improving Your Godot Code Using Components</title>
    <meta name="description" content="">
    <meta name="keywords" content='blog, gokarna, hugo, godot, gamedev'>

    <meta property="og:url" content="https://nishchalb.github.io/posts/catnap_components/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Break it up! Improving Your Godot Code Using Components">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://nishchalb.github.io/catnap_components/healthbar_examples.jpg">
    <meta property="og:image:secure_url" content="https://nishchalb.github.io/catnap_components/healthbar_examples.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Break it up! Improving Your Godot Code Using Components">
    <meta name="twitter:description" content="">
    <meta property="twitter:domain" content="https://nishchalb.github.io/posts/catnap_components/">
    <meta property="twitter:url" content="https://nishchalb.github.io/posts/catnap_components/">
    <meta name="twitter:image" content="https://nishchalb.github.io/catnap_components/healthbar_examples.jpg">

    
    <link rel="canonical" href="https://nishchalb.github.io/posts/catnap_components/" />

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js" integrity="sha256-7dmFWBv4YN&#43;0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script>
    // css
    <link rel="stylesheet" href="/css/custom.css">
    <a rel="me" href="https://mastodon.gamedev.place/@nish"></a>

    
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://nishchalb.github.io">
                <img src='/linkedin.jpeg' alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://nishchalb.github.io">Nishchal Bhandari</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://nishchalb.github.io/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://nishchalb.github.io/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://nishchalb.github.io/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://nishchalb.github.io/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/nishchalb"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://nishchalb.github.io/index.xml"><span data-feather='rss'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://nishchalb.github.io/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://nishchalb.github.io/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://nishchalb.github.io/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://nishchalb.github.io/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/nishchalb"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://nishchalb.github.io/index.xml"><span data-feather='rss'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Break it up! Improving Your Godot Code Using Components</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">October 14, 2024
        
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://nishchalb.github.io/tags/godot">godot</a></li>
        
            <li class="post-tag"><a href="https://nishchalb.github.io/tags/gamedev">gamedev</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>As your Godot project grows, it&rsquo;s incredibly important to keep your code and node structure organized to avoid it from resembling
a particularly notorious kind of pasta. The <a href="https://docs.godotengine.org/en/stable/tutorials/best_practices/scene_organization.html">Godot best practices</a> recommends having scenes that are singularly focused and loosely coupled. How can we achieve that in practice? In this article, I will explain
what is often called the <em>Component pattern</em> and go through some real-world examples from my recently released game
<a href="https://store.steampowered.com/app/3050120/Twinkle_Stardusts_Catnap_Chaos">Twinkle Stardust&rsquo;s Catnap Chaos</a> to demonstrate how you can use it.</p>
<h1 id="the-component-pattern">The Component pattern</h1>
<p>The key idea behind the component pattern is: rather than defining how something behaves via a chain of inheritance, we can
define its behavior by the components that compose it. A common example is a <em>Hitbox/Hurtbox component</em>. For any object that has a
hurtbox component, if it comes into contact with an object that has a hitbox component, the hurtbox will tell its owner to take damage.
Entities that require a hitbox don&rsquo;t need to inherit from some <code>HitboxEntity</code>, they can just contain the <code>Hitbox</code> component.</p>
<p>We will look at more examples shortly, but for now let&rsquo;s consider what makes a good component.</p>
<h2 id="isolation">Isolation</h2>
<p>To avoid unnecessary dependencies, components should be as isolated as possible. Ideally, their behavior
should not depend too much on the object they are affecting. In Godot terms, this means that they probably shouldn&rsquo;t directly change the state
of their parent, or other state elsewhere in the game.</p>
<p>If a component can&rsquo;t change state outside of it, how can we use it? We have a few options:</p>
<ul>
<li>Provide functions for its owner to use</li>
<li>Allow users of the component to read its state</li>
<li>Use signals</li>
</ul>
<h2 id="reusability">Reusability</h2>
<p>The component pattern doesn&rsquo;t make much sense for behaviors inherent to a single entity. You should avoid using this abstraction
just for the sake of it, and instead focus on how you could use it to simplify your codebase. What behaviors are commonly present in
your game?</p>
<h2 id="single-responsibility">Single responsibility</h2>
<p>The <a href="https://en.wikipedia.org/wiki/Single-responsibility_principle">single responsibility principle</a> for a component means that there should be only one reason for a component to change. This ensures that:</p>
<ul>
<li>If we want to change a behavior, we only need to do it in one place</li>
<li>When we change one behavior, we don&rsquo;t unintentionally break a different behavior</li>
</ul>
<p>In the <em>hitbox component</em> example, notice that we typically use a separate <em>hurtbox component</em> for the behavior of &ldquo;this entity can be hurt&rdquo;.
Even though these components feel similar, keeping them separate allows us to use them more flexibly. For example, we could have a <code>Crate</code>
that has a <em>hurtbox</em> to take damage, but isn&rsquo;t able to apply damage to other entities.</p>
<h2 id="configurability">Configurability</h2>
<p>To maximize reusability, a component should also be configurable. For example, if we have a <em>Jump Component</em>, we would probably
want its owner to be able to configure things like jump height and time.</p>
<h2 id="simple-interface">Simple Interface</h2>
<p>Because we prefer an isolated component that doesn&rsquo;t directly change state, it is helpful for a component to provide
a clear and easy to use interface. A component that exposes a single function is obvious to use, while a component with a dozen functions that must be
called in a specific order would be a headache to deal with.</p>
<h1 id="a-tour-of-example-components">A tour of example components</h1>
<p>The following components are not toy examples, but real components used in <a href="https://store.steampowered.com/app/3050120/Twinkle_Stardusts_Catnap_Chaos">Catnap Chaos</a>.</p>
<h2 id="speed-boost">Speed Boost</h2>
<p>This is one of the first components I created for Catnap Chaos. Unsurprisingly, it encapsulates the behavior of a speed boost.
The node structure is pretty simple:</p>
<p><img src="/catnap_components/speedboost_nodes.jpg" alt="Speed boost node structure"></p>
<p>There are some particles to accompany the speed boost, a mysterious <code>AnimationPlayer</code>, and a root node with a script. The script&rsquo;s interface is only
two different functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">speed_boost</span>(speed: <span style="color:#66d9ef">float</span>, double_boost: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>                 long_boost: <span style="color:#66d9ef">bool</span>, scale_mult: <span style="color:#66d9ef">float</span>):
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">extra_speed</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">float</span>:
</span></span></code></pre></div><p>The <code>speed_boost</code> function allows the caller to trigger a configurable speed boost. The <code>extra_speed</code> function allows a user of the component to read how much extra speed the boost is producing.
Internally, the <code>AnimationPlayer</code> adjusts how the speed boost varies over time. But because we expose a limited interface for nodes
that use this component, they don&rsquo;t need to interact with or depend on the fact that we&rsquo;re using an <code>AnimationPlayer</code>.</p>
<p>Notice that the component isn&rsquo;t changing its owner&rsquo;s speed directly. So how does it get used?
In Catnap Chaos, the component&rsquo;s owner decides when <code>speed_boost</code> is called. Alternatively, other systems could check
if a node has this component, and decide to trigger the speed boost.</p>
<p>To actually apply the speed boost, it&rsquo;s up to the owner to read <code>extra_speed()</code> and use it accordingly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#a6e22e">move_and_collide</span>(velocity<span style="color:#f92672">.</span><span style="color:#a6e22e">normalized</span>()<span style="color:#f92672">*</span><span style="color:#a6e22e">$SpeedBoost</span><span style="color:#f92672">.</span><span style="color:#a6e22e">extra_speed</span>()<span style="color:#f92672">*</span>delta)
</span></span></code></pre></div><p>Because our component is isolated, it does not care that its owner is a <code>PhysicsBody2D</code> node in this case. An <code>Area2D</code> would also be able
to reuse the same component and decide how to apply the speed boost to itself.</p>
<h2 id="bumpable">Bumpable</h2>
<p>One of my favorites! This component lets an object be &ldquo;bumped&rdquo;. The node structure is also very simple:</p>
<p><img src="/catnap_components/bumpable_node.jpg" alt="Bumpable node structure"></p>
<p>The interface for this component:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> velocity: <span style="color:#a6e22e">Vector2</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bump</span>(direction: <span style="color:#a6e22e">Vector2</span>, power: <span style="color:#66d9ef">float</span>, time: <span style="color:#66d9ef">float</span>):
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">interrupt_bump</span>():
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">signal</span> bump_completed
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">signal</span> bump_started
</span></span></code></pre></div><p>Like the <em>Speed Boost</em> component, <em>Bumpable</em> doesn&rsquo;t change its parent. Instead, it provides a <code>velocity</code> for its parent node to read the effect of a bump. This lets an entity with multiple components figure out how to combine different components. For example, both <em>Speed Boost</em> and <em>Bumpable</em> are
components that affect velocity. But, because they don&rsquo;t directly change an entity&rsquo;s velocity, the entity that owns them can make sure they play
together nicely:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#a6e22e">move_and_collide</span>((velocity<span style="color:#f92672">.</span><span style="color:#a6e22e">normalized</span>()<span style="color:#f92672">*</span><span style="color:#a6e22e">$SpeedBoost</span><span style="color:#f92672">.</span><span style="color:#a6e22e">extra_speed</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">$Bumpable</span><span style="color:#f92672">.</span>velocity)<span style="color:#f92672">*</span>delta)
</span></span></code></pre></div><p>The bump can be triggered by other nodes by checking for the component:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_on_Area2D_area_entered</span>(area):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> bumpable <span style="color:#f92672">=</span> area<span style="color:#f92672">.</span>owner<span style="color:#f92672">.</span><span style="color:#a6e22e">get_node_or_null</span>(<span style="color:#e6db74">&#34;Bumpable&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> bumpable:
</span></span><span style="display:flex;"><span>        bumpable<span style="color:#f92672">.</span><span style="color:#a6e22e">bump</span>(vel, <span style="color:#ae81ff">300.0</span>, <span style="color:#ae81ff">1.0</span>)
</span></span></code></pre></div><p>The signals are provided so that the <em>Bumpable</em> component doesn&rsquo;t need to know anything about its owner&rsquo;s animations. Instead,
the parent node can use them to coordinate animations like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">on_bump_completed</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">$SkeletonRoot/AnimationPlayer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">play</span>(<span style="color:#e6db74">&#34;Moving&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">on_bump_started</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">$SkeletonRoot/AnimationPlayer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">play</span>(<span style="color:#e6db74">&#34;Bumped&#34;</span>)
</span></span></code></pre></div><h2 id="health-bar">Health Bar</h2>
<p>To round it off, we&rsquo;ll look at a different kind of component, the <em>Health Bar</em>. This component is used to display a health bar.
It&rsquo;s not intended to be used as a general health system, so it doesn&rsquo;t contain any functionality for concepts like &ldquo;healing&rdquo; or &ldquo;death&rdquo;.</p>
<p><img src="/catnap_components/healthbar_nodes.jpg" alt="Health Bar node structure"></p>
<p>In its node tree, it most notably contains a <code>HBoxContainer</code> to display a row of hearts. The below image shows the component used in three different places: 1) The cat&rsquo;s health bar, 2) The boombox&rsquo;s health bar, and 3) The mouse&rsquo;s health bar.</p>
<p><img src="/catnap_components/healthbar_examples.jpg" alt="Health Bar example"></p>
<p>Because we limit the responsibility of the component, it can be easily used in this variety of situations. For each of the entities above, the health is used differently:</p>
<ul>
<li>The cat&rsquo;s health represents if the game is still going or not</li>
<li>The boombox&rsquo;s health represents how many music notes it has left</li>
<li>The mouse&rsquo;s health represents how many times it can bounce</li>
</ul>
<p>But all three can reuse the component.</p>
<p>Users of this component can interface with it using a few functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add_hp</span>(hp: <span style="color:#66d9ef">int</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">remove_hp</span>(hp: <span style="color:#66d9ef">int</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">set_hp</span>(hp: <span style="color:#66d9ef">int</span>):
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">get_hp</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">int</span>:
</span></span></code></pre></div><p>Internally, the component deals with adding heart sprites to its <code>HBoxContainer</code> and dynamically spacing them without its owner needing to worry about it.</p>
<h1 id="further-reading">Further Reading</h1>
<p>Hopefully this article inspires you to come up suitable components for your own game, so that you can avoid the aforementioned danger noodles (I&rsquo;m referring to spaghetti code in case I&rsquo;ve been too subtle). If you&rsquo;re interested in more resources about the <em>Component Patter</em>, you can take a look at:</p>
<ul>
<li><a href="https://www.gdquest.com/tutorial/godot/design-patterns/entity-component-pattern/">https://www.gdquest.com/tutorial/godot/design-patterns/entity-component-pattern/</a></li>
<li><a href="https://www.youtube.com/watch?v=74y6zWZfQKk">https://www.youtube.com/watch?v=74y6zWZfQKk</a></li>
<li><a href="https://www.youtube.com/watch?v=rCu8vQrdDDI">https://www.youtube.com/watch?v=rCu8vQrdDDI</a></li>
</ul>
<p>And to see the components I&rsquo;ve mentioned in action, you can play <a href="https://store.steampowered.com/app/3050120/Twinkle_Stardusts_Catnap_Chaos/">Twinkle Stardust&rsquo;s Catnap Chaos</a></p>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>

    
    
    <svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top">
        
        <path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/>
    </svg>
    
    <script>
        let backToTopButton = document.getElementById("btt-button");

        window.onscroll = function() {
            scrollFunction()
        };

        function scrollFunction() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                backToTopButton.style.display = "block";
            } else {
                backToTopButton.style.display = "none";
            }
        }

        function topFunction() {
            smoothScrollToTop();
        }

        function smoothScrollToTop() {
            const scrollToTop = () => {
                const c = document.documentElement.scrollTop || document.body.scrollTop;
                if (c > 0) {
                    window.requestAnimationFrame(scrollToTop);
                    window.scrollTo(0, c - c / 8);
                }
            };
            scrollToTop();
        }
    </script>
    
</div>


<section id="comments" class="comments">
  <h2>Comments</h2>
  <p>With an account on the Fediverse or Mastodon, you can respond to this <a href="https://mastodon.gamedev.place/@nish/113314837417924750">post</a>. Since Mastodon is decentralized, you can use your existing account hosted by another Mastodon server or compatible platform if you don't have an account on this one. Known non-private replies are displayed below.</p>

  <p id="mastodon-comments-list"><button id="load-comment">Load comments</button></p>
  <div id="comments-wrapper">
    <noscript><p>Loading comments relies on JavaScript. Try enabling JavaScript and reloading, or visit <a href="https://mastodon.gamedev.place/@nish/113314837417924750">the original post</a> on Mastodon.</p></noscript>
  </div>
  <noscript>You need JavaScript to view the comments.</noscript>
  <script src="/purify.min.js"></script>
  <script type="text/javascript">
    function escapeHtml(unsafe) {
      return unsafe
           .replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#039;");
    }
    function emojify(input, emojis) {
      let output = input;

      emojis.forEach(emoji => {
        let picture = document.createElement("picture");

        let source = document.createElement("source");
        source.setAttribute("srcset", escapeHtml(emoji.url));
        source.setAttribute("media", "(prefers-reduced-motion: no-preference)");

        let img = document.createElement("img");
        img.className = "emoji";
        img.setAttribute("src", escapeHtml(emoji.static_url));
        img.setAttribute("alt", `:${ emoji.shortcode }:`);
        img.setAttribute("title", `:${ emoji.shortcode }:`);

        picture.appendChild(source);
        picture.appendChild(img);

        output = output.replace(`:${ emoji.shortcode }:`, picture.outerHTML);
      });

      return output;
    }

    function loadComments() {
      let commentsWrapper = document.getElementById("comments-wrapper");
      document.getElementById("load-comment").innerHTML = "Loading";
      fetch('https://mastodon.gamedev.place/api/v1/statuses/113314837417924750/context')
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          let descendants = data['descendants'];
          if(
            descendants &&
            Array.isArray(descendants) &&
            descendants.length > 0
          ) {
            commentsWrapper.innerHTML = "";

            descendants.forEach(function(status) {
                console.log(descendants)
              if( status.account.display_name.length > 0 ) {
                status.account.display_name = escapeHtml(status.account.display_name);
                status.account.display_name = emojify(status.account.display_name, status.account.emojis);
              } else {
                status.account.display_name = status.account.username;
              };

              let instance = "";
              if( status.account.acct.includes("@") ) {
                instance = status.account.acct.split("@")[1];
              } else {
                instance = "mastodon.gamedev.place";
              }

              const isReply = status.in_reply_to_id !== "113314837417924750";

              let op = false;
              if( status.account.acct == "nish" ) {
                op = true;
              }

              status.content = emojify(status.content, status.emojis);

              let avatarSource = document.createElement("source");
              avatarSource.setAttribute("srcset", escapeHtml(status.account.avatar));
              avatarSource.setAttribute("media", "(prefers-reduced-motion: no-preference)");

              let avatarImg = document.createElement("img");
              avatarImg.className = "mastodon-avatar";
              avatarImg.setAttribute("src", escapeHtml(status.account.avatar_static));
              avatarImg.setAttribute("alt", `@${ status.account.username }@${ instance } avatar`);
              avatarImg.setAttribute("width", "60px");

              let avatarPicture = document.createElement("picture");
              avatarPicture.appendChild(avatarSource);
              avatarPicture.appendChild(avatarImg);

              let avatar = document.createElement("a");
              avatar.className = "avatar-link";
              avatar.setAttribute("href", status.account.url);
              avatar.setAttribute("rel", "external nofollow");
              avatar.setAttribute("title", `View profile at @${ status.account.username }@${ instance }`);
              avatar.appendChild(avatarPicture);

              let instanceBadge = document.createElement("a");
              instanceBadge.className = "instance";
              instanceBadge.setAttribute("href", status.account.url);
              instanceBadge.setAttribute("title", `@${ status.account.username }@${ instance }`);
              instanceBadge.setAttribute("rel", "external nofollow");
              instanceBadge.textContent = instance;

              let display = document.createElement("span");
              display.className = "display";
              display.setAttribute("itemprop", "author");
              display.setAttribute("itemtype", "http://schema.org/Person");
              display.innerHTML = status.account.display_name;

              let header = document.createElement("header");
              header.className = "author";
              header.appendChild(display);
              header.appendChild(instanceBadge);

              let permalink = document.createElement("a");
              permalink.setAttribute("href", status.url);
              permalink.setAttribute("itemprop", "url");
              permalink.setAttribute("title", `View comment at ${ instance }`);
              permalink.setAttribute("rel", "external nofollow");
              permalink.textContent = new Date( status.created_at ).toLocaleString('en-US', {
                dateStyle: "long",
                timeStyle: "short",
              });

              let timestamp = document.createElement("time");
              timestamp.setAttribute("datetime", status.created_at);
              timestamp.appendChild(permalink);

              let main = document.createElement("main");
              main.setAttribute("itemprop", "text");
              main.innerHTML = status.content;

              let interactions = document.createElement("footer");
              if(status.favourites_count > 0) {
                let faves = document.createElement("a");
                faves.className = "faves";
                faves.setAttribute("href", `${ status.url }/favourites`);
                faves.setAttribute("title", `Favorites from ${ instance }`);
                faves.textContent = status.favourites_count;

                interactions.appendChild(faves);
              }

              let comment = document.createElement("article");
              comment.id = `comment-${ status.id }`;
              comment.className = isReply ? "mastodon-comment comment-reply" : "mastodon-comment";
              comment.setAttribute("itemprop", "comment");
              comment.setAttribute("itemtype", "http://schema.org/Comment");
              comment.appendChild(avatar);
              comment.appendChild(header);
              comment.appendChild(timestamp);
              comment.appendChild(main);
              comment.appendChild(interactions);

              if(op === true) {
                comment.classList.add("op");

                avatar.classList.add("op");
                avatar.setAttribute(
                  "title",
                  "Blog post author; " + avatar.getAttribute("title")
                );

                instanceBadge.classList.add("op");
                instanceBadge.setAttribute(
                  "title",
                  "Blog post author: " + instanceBadge.getAttribute("title")
                );
              }

              commentsWrapper.innerHTML += DOMPurify.sanitize(comment.outerHTML);
            });
          }
        });
      }
      document.getElementById("load-comment").addEventListener("click", loadComments);
  </script>
</section>


    

    

        </main><footer class="footer">
    
    

    
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
